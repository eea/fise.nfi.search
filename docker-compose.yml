version: '2'

services:

  tika:
    image: logicalspark/docker-tikaserver

  app:
    image: eeacms/fise.nfi.search:latest
    environment:
      - TZ=Europe/Copenhagen
    env_file:
      - docker/postgres.env
      - docker/app.env
    volumes:
      - static-files:/var/local/fise.nfi.search/static
      - data-files:/var/local/fise.nfi.search/data_files
      - import-files:/var/local/fise.nfi.search/import_files
    depends_on:
      - tika

  nginx:
    image: nginx:latest
    environment:
      NGINX_CONF: |-
        upstream app {
          ip_hash;
          server app:${DJANGO_PORT};
        }

        server {
          listen 80;
          server_name ${NFI_SEARCH_DOMAIN};
          client_max_body_size 50M;
          access_log /var/log/nginx/access.log main;
          location / {
            uwsgi_pass app;
            include uwsgi_params;
          }
          location /static {
            sendfile on;
            tcp_nopush on;
            gzip on;
            gzip_types text/plain application/x-javascript text/css;
            expires 1d;
            root /var/local/fise.nfi.search;
          }
        }
    command: /bin/sh -c 'echo "$$NGINX_CONF" > /etc/nginx/conf.d/default.conf && exec nginx -g "daemon off;"'
    volumes:
      - static-files:/var/local/fise.nfi.search/static:ro
    depends_on:
      - app

volumes:
  static-files:
    driver: local
  data-files:
    driver: local
  import-files:
    driver: local
